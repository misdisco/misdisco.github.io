

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/YoRHa.ico">
  <link rel="icon" href="/img/YoRHa.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="吕书科">
  <meta name="keywords" content="">
  
    <meta name="description" content="1.1 MongoDB概述MongoDB是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。 MongoDB是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。 它支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是它支持的查询语言非常强大，其语法有">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB图文详解">
<meta property="og:url" content="http://example.com/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="Automata">
<meta property="og:description" content="1.1 MongoDB概述MongoDB是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。 MongoDB是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。 它支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是它支持的查询语言非常强大，其语法有">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/mongodb.jpeg">
<meta property="article:published_time" content="2021-03-16T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-13T17:11:47.653Z">
<meta property="article:author" content="吕书科">
<meta property="article:tag" content="MongoDB">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="非关系型数据库">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/mongodb.jpeg">
  
  
  
  <title>MongoDB图文详解 - Automata</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Automata</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/mongodb.jpeg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MongoDB图文详解"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-03-17 00:00" pubdate>
          2021年3月17日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          107 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">MongoDB图文详解</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="1-1-MongoDB概述"><a href="#1-1-MongoDB概述" class="headerlink" title="1.1 MongoDB概述"></a>1.1 <code>MongoDB</code>概述</h3><p><code>MongoDB</code>是一个基于<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%88%86%E5%B8%83%E5%BC%8F&spm=1001.2101.3001.7020">分布式</a>文件存储的数据库。由<code>C++</code>语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。</p>
<p><code>MongoDB</code>是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。</p>
<p>它支持的数据结构非常松散，是类似<code>json</code>的<code>bson</code>格式，因此可以存储比较复杂的数据类型。<code>Mongo</code>最大的特点是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p>
<p><code>MongoDB</code>服务端可运行在<code>Linux</code>、<code>Windows</code>平台，支持<code>32</code>位和<code>64</code>位应用，默认端口为<code>27017</code>。<br>推荐运行在<code>64</code>位平台，因为<code>MongoD</code>B在<code>32</code>位模式运行时支持的最大文件尺寸为<code>2</code>GB。</p>
<h3 id="1-2-MongoDB-主要特点"><a href="#1-2-MongoDB-主要特点" class="headerlink" title="1.2 MongoDB 主要特点"></a>1.2 <code>MongoDB </code>主要特点</h3><h4 id="1-2-1-文档"><a href="#1-2-1-文档" class="headerlink" title="1.2.1 文档"></a>1.2.1 文档</h4><p><code>MongoDB</code>中的记录是一个文档，它是由字段和值对组成的数据结构。<br>多个键及其关联的值有序地放在一起就构成了文档。<br><code>MongoDB</code>文档类似于<code>JSON</code>对象。字段的值可以包括其他文档，数组和文档数组。<br><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/68af6e5064f5dc8e5693bd4cacd973ff.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br><code>&#123;“greeting”:“hello,world”&#125;</code>这个文档只有一个键<code>“greeting”</code>，对应的值为<code>“hello,world”</code>。多数情况下，文档比这个更复杂，它包含多个键&#x2F;值对。</p>
<p>例如：<code>&#123;“greeting”:“hello,world”,“foo”: 3&#125;</code> 文档中的键&#x2F;值对是有序的，下面的文档与上面的文档是完全不同的两个文档。<code>&#123;“foo”: 3 ,“greeting”:“hello,world”&#125;</code></p>
<p><strong>文档中的值不仅可以是双引号中的字符串，也可以是其他的数据类型，例如，整型、布尔型等，也可以是另外一个文档，即文档可以嵌套。文档中的键类型只能是字符串</strong>。</p>
<p>使用文档的优点是：</p>
<ul>
<li>文档（即对象）对应于许多编程语言中的本机数据类型</li>
<li>嵌入式文档和数组减少了对昂贵连接的需求</li>
<li>动态模式支持流畅的多态性</li>
</ul>
<h4 id="1-3-2-集合"><a href="#1-3-2-集合" class="headerlink" title="1.3.2 集合"></a>1.3.2 集合</h4><p><strong>集合就是一组文档，类似于关系数据库中的表。</strong></p>
<p>集合是无模式的，集合中的文档可以是各式各样的。例如，<code>&#123;“hello,word”:“Mike”&#125;</code>和<code>&#123;“foo”: 3&#125;</code>，它们的键不同，值的类型也不同，但是它们可以存放在同一个集合中，也就是不同模式的文档都可以放在同一个集合中。</p>
<p><strong>既然集合中可以存放任何类型的文档，那么为什么还需要使用多个集合？</strong><br>这是因为所有文档都放在同一个集合中，无论对于开发者还是管理员，都很难对集合进行管理，而且这种情形下，对集合的查询等操作效率都不高。所以在实际使用中，往往将文档分类存放在不同的集合中。<br>例如，对于网站的日志记录，可以根据日志的级别进行存储，<code>Info</code>级别日志存放在<code>Info</code> 集合中，<code>Debug</code> 级别日志存放在<code>Debug</code> 集合中，这样既方便了管理，也提供了查询性能。<br>但是需要注意的是，这种对文档进行划分来分别存储并不是<code>MongoDB</code> 的强制要求，用户可以灵活选择。</p>
<p>可以使用<code>“.”</code>按照命名空间将集合划分为子集合。<br>例如，对于一个博客系统，可能包括<code>blog.user </code>和<code>blog.article </code>两个子集合，这样划分只是让组织结构更好一些，<code>blog </code>集合和<code>blog.user</code>、<code>blog.article </code>没有任何关系。虽然子集合没有任何特殊的地方，但是使用子集合组织数据结构清晰，这也是<code>MongoDB </code>推荐的方法。</p>
<h4 id="1-3-3-数据库"><a href="#1-3-3-数据库" class="headerlink" title="1.3.3 数据库"></a>1.3.3 数据库</h4><p><code>MongoDB</code> 中多个文档组成集合，多个集合组成数据库。</p>
<p>一个<code>MongoDB </code>实例可以承载多个数据库。它们之间可以看作相互独立，每个数据库都有独立的权限控制。在磁盘上，不同的数据库存放在不同的文件中。</p>
<p><code>MongoDB </code>中存在以下系统数据库。</p>
<ul>
<li><code>Admin</code> 数据库：一个权限数据库，如果创建用户的时候将该用户添加到<code>admin</code> 数据库中，那么该用户就自动继承了所有数据库的权限。</li>
<li><code>Local</code> 数据库：这个数据库永远不会被复制，可以用来存储本地单台服务器的任意集合。</li>
<li><code>Config</code> 数据库：当<code>MongoDB</code> 使用分片模式时，<code>config </code>数据库在内部使用，用于保存分片的信息。</li>
</ul>
<h4 id="1-3-4-数据模型"><a href="#1-3-4-数据模型" class="headerlink" title="1.3.4 数据模型"></a>1.3.4 数据模型</h4><p>一个<code>MongoDB </code>实例可以包含一组数据库，一个<code>DataBase </code>可以包含一组<code>Collection</code>（集合），一个集合可以包含一组<code>Document</code>（文档）。</p>
<p>一个<code>Document</code>包含一组<code>field</code>（字段），每一个字段都是一个<code>key/value pair</code></p>
<ul>
<li><p><code>key</code>: 必须为字符串类型</p>
</li>
<li><pre><code class="hljs">value
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs mel"><br>  ：可以包含如下类型<br><br>  - 基本类型，例如，<span class="hljs-string">`string，int，float，timestamp，binary`</span> 等类型<br>  - 一个<span class="hljs-string">`document`</span><br>  - 数组类型<br><br>### <span class="hljs-number">1.4</span> <span class="hljs-string">`Windows`</span>安装<span class="hljs-string">`MongoDB`</span><br><br>#### <span class="hljs-number">1.4</span><span class="hljs-number">.1</span> 下载<span class="hljs-string">`MongoDB`</span><br><br><span class="hljs-string">`MongoDB`</span>提供了可用于<span class="hljs-string">`32`</span>位系统和<span class="hljs-string">`64`</span>位系统的预编译二进制包（新版本没有了<span class="hljs-string">`32`</span>位系统的安装文件），你可以进入<span class="hljs-string">`MongoDB`</span>官网下载安装，<span class="hljs-string">`MongoDB`</span>的预编译二进制包的下载地址为：<span class="hljs-string">`https://www.mongodb.com/download-center/community`</span>，打开之后会看到如下图，直接点击<span class="hljs-string">`Download`</span>下载即可，也可以在<span class="hljs-string">`Version`</span>中选择你想要的版本：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/bd2180a0c430025e845b7511892c190a.png)<br><br>#### <span class="hljs-number">1.4</span><span class="hljs-number">.2</span> 安装<span class="hljs-string">`MongoDB`</span><br><br>双击打开文件进行安装，在安装过程中，可以通过点击 “<span class="hljs-string">`Custom`</span>(自定义)” 按钮来设置你的安装目录。<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/dd6b8a5125d14b0813d4b894a6e0b4cf.png)<br>这里我选择安装在<span class="hljs-string">`E:\MongoDB`</span>这个目录下（安装目录会影响我们后面的配置）<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/e4175bec094c93c2fa3198f6f422af4f.png)<br>这里选择直接<span class="hljs-string">`next`</span><br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">48135</span>ad76119ee06d10d5f09144dc754.png)<br>这里安装 <span class="hljs-string">`&quot;Install MongoDB Compass&quot; `</span>不勾选，否则可能要很长时间都一直在执行安装，<span class="hljs-string">`MongoDB Compass`</span>是一个图形界面管理工具，这里不安装也是没有问题的，可以自己去下载一个图形界面管理工具，比如<span class="hljs-string">`Robo3T`</span>。<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/c2dcf56dcbf9af84bea01400cd1152e2.png)<br>之后稍微等待一会就安装好了。<br><br>#### <span class="hljs-number">1.4</span><span class="hljs-number">.3</span> 配置<span class="hljs-string">`MongoDB`</span><br><br><span class="hljs-string">`MongoDB`</span>的安装过程是很简单的，但是配置就比较麻烦了，可能会遇到各种各样的问题，需要你有足够的耐心和仔细。<br><br>首先要在<span class="hljs-string">`MongoDB`</span>的<span class="hljs-string">`data`</span>文件夹里新建一个<span class="hljs-string">`db`</span>文件夹和一个<span class="hljs-string">`log`</span>文件夹：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">169019</span>bfed75c0179558a73189cd6f03.png)<br>然后在<span class="hljs-keyword">log</span>文件夹下新建一个mongo.<span class="hljs-keyword">log</span>：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">0e8</span>f5e360b032fd9ce90dd7ee77b5a0b.png)<br>然后将<span class="hljs-string">`E:\MongoDB\bin`</span>添加到环境变量<span class="hljs-string">`path`</span>中，此时打开<span class="hljs-string">`cmd`</span>窗口运行一下<span class="hljs-string">`mongo`</span>命令，出现如下情况：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/ce17513c47fef290e9eb3df60d61042b.png)<br>这是为什么呢？这是因为我们还没有启动<span class="hljs-string">`MongoDB`</span>服务，自然也就连接不上服务了。那要怎么启动呢？在<span class="hljs-string">`cmd`</span>窗口中运行如下命令：<br><br></code></pre></td></tr></table></figure>
 mongod --dbpath E:\MongoDB\data\db
</code></pre>
</li>
</ul>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mel"><br>需要注意的是：如果你没有提前创建<span class="hljs-string">`db`</span>文件夹，是无法启动成功的。运行成功之后，我们打开浏览器，输入<span class="hljs-string">`127.0.0.1:27017`</span>，看到如下图，就说明<span class="hljs-string">`MongoDB`</span>服务已经成功启动了。<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">77</span>b1547194546cc209c76a5e957e7c05.png)<br>但是如果每次都要这么启动服务的话也太麻烦了吧，这里你可以选择设置成开机自启动，也可以选择用命令<span class="hljs-string">`net start mongodb`</span>来手动启动，这里我选择使用后者，具体方法如下。<br><br>还是打开<span class="hljs-string">`cmd`</span>窗口，不过这次是以管理员身份运行，然后输入如下命令：<br><br></code></pre></td></tr></table></figure>
<p>mongod –dbpath “E:\MongoDB\data\db” –logpath “E:\MongoDB\data\log\mongo.log” -install -serviceName “MongoDB”</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mel"><br>如果没有报错的话就说明成功添加到服务里了，可以使用<span class="hljs-string">`win+R`</span>然后输入<span class="hljs-string">`services.msc`</span>命令进行查看：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">062</span>bd6f16a9ea746ab2c48e7fea5d6cf.png)<br>默认是自动运行的，这里我选择把它改成手动的。然后在<span class="hljs-string">`cmd`</span>窗口中运行<span class="hljs-string">`net start mongodb`</span>：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/ee7ba8a2a7ab7622231d53efd99b3a06.png)<br>怎么解决呢？两个步骤：<br><span class="hljs-number">1</span>）运行<span class="hljs-string">`sc delete mongodb`</span>删除服务；<br><span class="hljs-number">2</span>）再运行一次配置服务的命令：<br><br></code></pre></td></tr></table></figure>
<p>mongod –dbpath “E:\MongoDB\data\db” –logpath “E:\MongoDB\data\log\mongo.log” -install -serviceName “MongoDB”</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs mel"><br>然后再运行<span class="hljs-string">`net start mongodb`</span>，服务启动成功：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">9</span>acc9b0204dcb2419f6f35d385d11240.png)<br>可能遇到的问题：<br><span class="hljs-number">1</span>、<span class="hljs-string">`mongod`</span>不是内部或外部命令<br>出现这种问题说明你没有把<span class="hljs-string">`bin`</span>目录添加到环境变量之中，重新添加一下即可解决。<br><br><span class="hljs-number">2</span>、服务名无效<br>首先是看你输入的服务名称是否有误，然后再查看本地服务中有没有<span class="hljs-string">`MongoDB`</span>服务，如果没有服务，则运行命令添加服务即可。<br><br><span class="hljs-number">3</span>、发生服务特定错误：<span class="hljs-string">`100`</span><br>删除<span class="hljs-string">`db`</span>文件夹下的<span class="hljs-string">`mongod.lock`</span>和<span class="hljs-string">`storage.bson`</span>两个文件，若删除完之后仍然出现这种问题，用<span class="hljs-string">`sc delete mongodb`</span>删除服务，再配置一下服务就能解决了。<br><br>#### <span class="hljs-number">1.4</span><span class="hljs-number">.4</span> 安装一个可视化工具<br><br>官网下载 <span class="hljs-string">`RoBo 3T（Robomongo is now Robo 3T）`</span><br>下载地址：<span class="hljs-string">`https://robomongo.org/download`</span><br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">25</span>f0054494c50492de62a0a9914e7b9b.png)<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">8834336317</span>f5dcd45bc70aba13d9e37d.png)<br>双击安装包安装，修改安装路径，不停下一步，点击安装。<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">6</span>c7a608d50f395156924853d955fc91c.png)<br>打开后，有一个填信息的页面，<span class="hljs-string">`name`</span>、<span class="hljs-string">`email`</span>，暂时不用管，直接<span class="hljs-string">`finish`</span>。<br>启动<span class="hljs-string">`MongoDB`</span>服务。<br>点击弹出框中的<span class="hljs-string">`create`</span>，创建新连接，可以修改连接名<span class="hljs-string">`name`</span>，连接<span class="hljs-string">`IP`</span>(下图<span class="hljs-string">`IP`</span>为本地<span class="hljs-string">`IP`</span>)，端口(默认)<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/e6abf43c32cc63b4ac3e908ee2f14a31.png)<br>连接成功后，右击<span class="hljs-string">`localhost`</span>，选择<span class="hljs-string">`create Database`</span>，创建数据库<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">459</span>bc287cc9e026bcfcc2bacbf52e21e.png)<br>创建数据库<span class="hljs-string">`firstTest`</span>，然后右击<span class="hljs-string">`firstTest`</span>，选择<span class="hljs-string">`open Shell`</span>，开始进行<span class="hljs-string">`shell`</span>命令来创建数据库中的集合和文档。<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/cc05db6938fda3ac46b54c6a9b507cbe.png)<br><br>### <span class="hljs-number">1.5</span> <span class="hljs-string">`Linux`</span>安装<span class="hljs-string">`MongoDB`</span><br><br>#### <span class="hljs-number">1.5</span><span class="hljs-number">.1</span> 下载<span class="hljs-string">`MongoDB`</span><br><br>官方下载地址：<span class="hljs-string">`https://www.mongodb.com/download-center/community`</span><br><br></code></pre></td></tr></table></figure>
<p>wget <a target="_blank" rel="noopener" href="https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.2.1.tgz">https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.2.1.tgz</a></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs clean"><br>#### <span class="hljs-number">1.5</span><span class="hljs-number">.2</span> 解压安装<br><br><span class="hljs-number">1</span>、解压<br><br></code></pre></td></tr></table></figure>
<p>tar -zxvf mongodb-linux-x86_64-rhel70-4.2.1.tgz</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><br><span class="hljs-number">2</span>、创建目录`/usr/local/mongo`，并将解压完的`mongodb`目录移动到`/usr/local/mongo`下<br><br></code></pre></td></tr></table></figure>
<p>mkdir -p &#x2F;usr&#x2F;local&#x2F;mongo<br>mv mongodb-linux-x86_64-rhel70-4.2.1&#x2F;* &#x2F;usr&#x2F;local&#x2F;mongo&#x2F; </p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><br><span class="hljs-number">3</span>、切到`/usr/local/mongo`目录下，创建目录<br><br></code></pre></td></tr></table></figure>
<p>mkdir -p data&#x2F;db        #数据库目录<br>mkdir -p logs           #日志目录<br>mkdir -p conf           #配置文件目录<br>mkdir -p pids           #进程描述文件目录</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mel"><br>创建好的目录如下：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">38e7</span>faedc4fb67843c2d61728be8d764.png)<br><span class="hljs-number">4</span>、在<span class="hljs-string">`conf`</span>目录，增加配置文件<span class="hljs-string">`mongo.conf`</span><br><br></code></pre></td></tr></table></figure>
<p>vi &#x2F;usr&#x2F;local&#x2F;mongo&#x2F;conf&#x2F;mongo.conf<br>1<br>#数据保存路径<br>dbpath&#x3D;&#x2F;usr&#x2F;local&#x2F;mongo&#x2F;data&#x2F;db&#x2F;<br>#日志保存路径<br>logpath&#x3D;&#x2F;usr&#x2F;local&#x2F;mongo&#x2F;logs&#x2F;mongo.log<br>#进程描述文件<br>pidfilepath&#x3D;&#x2F;usr&#x2F;local&#x2F;mongo&#x2F;pids&#x2F;mongo.pid<br>#日志追加写入<br>logappend&#x3D;true<br>bind_ip_all&#x3D;true<br>#mongo默认端口<br>port&#x3D;27017<br>#操作日志容量<br>oplogSize&#x3D;10000<br>#开启子进程<br>fork&#x3D;true</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><br><span class="hljs-number">5</span>、通过配置文件启动`mongo`服务端<br><br></code></pre></td></tr></table></figure>
<p>&#x2F;usr&#x2F;local&#x2F;mongo&#x2F;bin&#x2F;mongod -f &#x2F;usr&#x2F;local&#x2F;mongo&#x2F;conf&#x2F;mongo.conf</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><br>启动成功如下：<br>![在这里插入图片描述](MongoDB<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%BE</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%96</span><span class="hljs-variable">%87</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%A3</span>/<span class="hljs-number">80e16519452</span>b<span class="hljs-number">5</span>d<span class="hljs-number">3</span>a<span class="hljs-number">6</span><span class="hljs-keyword">c</span><span class="hljs-number">03</span>a<span class="hljs-number">584</span>ac<span class="hljs-number">115288</span>.png)<br><span class="hljs-number">6</span>、启动`mongo`客户端<br><br></code></pre></td></tr></table></figure>
<p>&#x2F;usr&#x2F;local&#x2F;mongo&#x2F;bin&#x2F;mongo –host 127.0.0.1 –port 27017</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mel"><br>启动成功如下：<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">1</span>ff26f58a735150ecc53eabf255e7e32.png)<br>至此安装完成~<br><br>### <span class="hljs-number">1.6</span> <span class="hljs-string">`MongoDB`</span>基本操作及增删改查<br><br>#### <span class="hljs-number">1.6</span><span class="hljs-number">.1</span> 基本操作<br><br>登陆数据库<br><br></code></pre></td></tr></table></figure>
<p>mongo</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br><span class="hljs-strong">**查看数据库**</span><br><br></code></pre></td></tr></table></figure>
<p>show databases;</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><br>![在这里插入图片描述](MongoDB<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%BE</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%96</span><span class="hljs-variable">%87</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%A3</span>/b<span class="hljs-number">0</span>f<span class="hljs-number">3754</span>b<span class="hljs-number">7</span>a<span class="hljs-number">816333</span><span class="hljs-keyword">c</span><span class="hljs-number">126</span><span class="hljs-keyword">cc</span><span class="hljs-number">110380</span>a<span class="hljs-number">0</span>a<span class="hljs-number">8</span>.png)<br>**选择数据库**<br>`use `数据库名<br>![在这里插入图片描述](MongoDB<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%BE</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%96</span><span class="hljs-variable">%87</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%A3</span>/<span class="hljs-number">8</span>d<span class="hljs-number">8141</span>b<span class="hljs-number">608</span>b<span class="hljs-number">16</span>ae<span class="hljs-number">288</span>da<span class="hljs-number">0</span>b<span class="hljs-number">8</span>bc<span class="hljs-number">8</span>da<span class="hljs-number">6</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span><span class="hljs-keyword">c</span>.png)<br>如果切换到一个没有的数据库，例如`use admin<span class="hljs-number">2</span>`，那么会隐式创建这个数据库。（后期当该数据库有数据时，系统自动创建）<br><br></code></pre></td></tr></table></figure>
<p>use admin2</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><br>![在这里插入图片描述](MongoDB<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%BE</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%96</span><span class="hljs-variable">%87</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%A3</span>/<span class="hljs-number">5458</span>a<span class="hljs-number">870</span>b<span class="hljs-number">09</span>d<span class="hljs-number">88</span>a<span class="hljs-number">1</span>f<span class="hljs-number">1</span>ed<span class="hljs-number">3</span>fd<span class="hljs-number">93e847320</span>.png)<br>**查看集合**<br><br></code></pre></td></tr></table></figure>
<p>show collections</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><br>![在这里插入图片描述](MongoDB<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%BE</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%96</span><span class="hljs-variable">%87</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%A3</span>/<span class="hljs-number">404</span>ea<span class="hljs-number">355</span>cfced<span class="hljs-number">9</span>a<span class="hljs-number">1</span>fc<span class="hljs-number">82</span>cdf<span class="hljs-number">5</span>f<span class="hljs-number">6e7</span>e<span class="hljs-number">5</span>d<span class="hljs-number">6</span>.png)<br>**创建集合**<br><br></code></pre></td></tr></table></figure>
<p>db.createCollection(‘集合名’)</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><br>![在这里插入图片描述](MongoDB<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%BE</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%96</span><span class="hljs-variable">%87</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%A3</span>/ed<span class="hljs-number">4</span><span class="hljs-keyword">c</span><span class="hljs-number">38322</span>cdb<span class="hljs-number">8</span><span class="hljs-keyword">cc</span><span class="hljs-number">4</span>aefa<span class="hljs-number">3878</span>b<span class="hljs-number">45</span>f<span class="hljs-number">9</span>a<span class="hljs-number">31</span>.png)<br>**删除集合**<br><br></code></pre></td></tr></table></figure>
<p><code>db.集合名.drop()</code></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mel"><br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">52703</span>c7fbd07175e5dbde2a479a6ad75.png)<br>**删除数据库**<br>通过<span class="hljs-string">`use`</span>语法选择数据<br>通过<span class="hljs-string">`db.dropDataBase()`</span>删除数据库<br>![在这里插入图片描述](MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/<span class="hljs-number">9e0</span>cbbdfb3b19b72b9bb48024dbd39db.png)<br><br>#### <span class="hljs-number">1.6</span><span class="hljs-number">.2</span> 增删改查<br><br>##### <span class="hljs-number">1.6</span><span class="hljs-number">.2</span><span class="hljs-number">.1</span> 增加<br><br></code></pre></td></tr></table></figure>
<p>db.集合名.insert(JSON数据)</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><br>如果集合存在，那么直接插入数据。如果集合不存在，那么会隐式创建。<br><br>示例：在`test2`数据库的`c1`集合中插入数据（姓名叫`webopenfather`年龄`18`岁）<br><br></code></pre></td></tr></table></figure>
<p>use test2 db.c1.insert({uname:”webopenfather”,age:18})</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br><span class="hljs-bullet">- </span>数据库和集合不存在都隐式创建<br><br><span class="hljs-bullet">- </span>对象的键统一不加引号（方便看），但是查看集合数据时系统会自动加<br><br><span class="hljs-bullet">- </span><span class="hljs-code">```</span><br><span class="hljs-code">  mongodb</span><br></code></pre></td></tr></table></figure>

<p>  会给每条数据增加一个全球唯一的</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">_<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>

<p>  键</p>
<ul>
<li><p><code>_id</code>键的组成<br><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/a2e72a45461564de9265d5ffde408e09.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
</li>
<li><p>自己增加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">_<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>

<p>可以，只需要给插入的</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">JSON</span><br></code></pre></td></tr></table></figure>

<p>数据增加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">_<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>

<p>键即可覆盖（但实战强烈不推荐）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">db.c1.<span class="hljs-title function_ invoke__">insert</span>(&#123;<span class="hljs-attr">_id</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">uname</span>:<span class="hljs-string">&quot;webopenfather&quot;</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>&#125;)<br></code></pre></td></tr></table></figure></li>
</ul>
<p><strong>一次性插入多条数据</strong><br>传递数据，数组中写一个个<code>JSON</code>数据即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">db.c1.<span class="hljs-title function_ invoke__">insert</span>([     &#123;<span class="hljs-attr">uname</span>:<span class="hljs-string">&quot;z3&quot;</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">3</span>&#125;,     &#123;<span class="hljs-attr">uname</span>:<span class="hljs-string">&quot;z4&quot;</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">4</span>&#125;,     &#123;<span class="hljs-attr">uname</span>:<span class="hljs-string">&quot;w5&quot;</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">5</span>&#125; ])<br></code></pre></td></tr></table></figure>

<p><strong>快速插入<code>10</code>条数据</strong><br>由于<code>mongodb</code>底层使用<code>JS</code>引擎实现的，所以支持部分<code>js</code>语法。因此：可以写<code>for</code>循环</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">1</span>; i&lt;=<span class="hljs-number">10</span>; i++) &#123;     db.c2.<span class="hljs-title function_ invoke__">insert</span>(&#123;<span class="hljs-attr">uanme</span>: <span class="hljs-string">&quot;a&quot;</span>+i, <span class="hljs-attr">age</span>: i&#125;) &#125;<br></code></pre></td></tr></table></figure>

<p><strong>查询文档</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.集合名.<span class="hljs-built_in">find</span>(条件[,查询的列])<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>条件</th>
<th>写法</th>
</tr>
</thead>
<tbody><tr>
<td>查询所有的数据</td>
<td>{}或者不写</td>
</tr>
<tr>
<td>查询age&#x3D;6的数据</td>
<td>{age:6}</td>
</tr>
<tr>
<td>既要age&#x3D;6又要性别&#x3D;男</td>
<td>{age:6,sex:‘男’}</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>查询的列（可选参数）</th>
<th>写法</th>
</tr>
</thead>
<tbody><tr>
<td>查询全部列（字段）</td>
<td>不写</td>
</tr>
<tr>
<td>只显示age列（字段）</td>
<td>{age:1}</td>
</tr>
<tr>
<td>除了age列（字段）都显示</td>
<td>{age:0}</td>
</tr>
</tbody></table>
<p>其他语法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.集合名.<span class="hljs-built_in">find</span>(&#123;<br>            键:&#123;运算符：值&#125;<br>            &#125;)<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>运算符</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>$gt</td>
<td>大于</td>
</tr>
<tr>
<td>$gte</td>
<td>大于等于</td>
</tr>
<tr>
<td>$lt</td>
<td>小于</td>
</tr>
<tr>
<td>$lte</td>
<td>小于等于</td>
</tr>
<tr>
<td>$ne</td>
<td>不等于</td>
</tr>
<tr>
<td>$in</td>
<td>in</td>
</tr>
<tr>
<td>$nin</td>
<td>not in</td>
</tr>
<tr>
<td><strong>实例练习</strong></td>
<td></td>
</tr>
<tr>
<td>查询所有数据</td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.c1.<span class="hljs-built_in">find</span>()<br></code></pre></td></tr></table></figure>

<p><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/110264d03c2d08d0a2befa2d2bb676e1.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>系统的<code>_id</code>无论如何都会存在</p>
<p>1、查询<code>age</code>大于<code>5</code>的数据</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.c1.<span class="hljs-built_in">find</span>(&#123;age:&#123;<span class="hljs-variable">$gt</span>:5&#125;&#125;)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/a1eea168bea875edbded0059f8574caa.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>2、查询年龄是<code>5</code>岁、<code>8</code>岁、<code>10</code>岁的数据</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.c2</span><span class="hljs-selector-class">.find</span>(&#123;age:&#123;<span class="hljs-variable">$in</span>:<span class="hljs-selector-attr">[5,8,10]</span>&#125;&#125;)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/f7997d7b39e0ed11ac53b6c26f6fc009.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>3、只看年龄列，或者年龄以外的列<br><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/9f638c9025983e6c94eba99365175ca1.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="1-6-3-修改文档"><a href="#1-6-3-修改文档" class="headerlink" title="1.6.3 修改文档"></a>1.6.3 修改文档</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">db</span>.集合名.<span class="hljs-keyword">update</span>(条件,新数据[是否新增,是否修改多条,])<br></code></pre></td></tr></table></figure>

<ul>
<li>新数据此数据需要使用修改器，如果不使用，那么会将新数据替换原来的数据。<code>1db.集合名.update(条件,&#123;修改器:&#123;键:值&#125;&#125;[是否新增,是否修改多条,])</code><br>修改器作用<code>inc</code>递增<code>rename</code>重命名列<code>set</code>修改列值<code>unset</code>删除列</li>
<li>是否新增<br>指条件匹配不到数据则插入(<code>true</code>是插入，<code>false</code>否不插入默认)<br><code>db.c3.update(&#123;uname:&quot;zs30&quot;&#125;,&#123;$set:&#123;age:30&#125;&#125;,true)</code><br><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/03ae1eb7f3e9be02847d94e606f57f23.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></li>
<li>是否修改多条<br>指将匹配成功的数据都修改（<code>true</code>是，<code>false</code>否默认）<br><code>db.c3.update(&#123;uname:&quot;zs2&quot;&#125;,&#123;$set:&#123;age:30&#125;&#125;,false,true)</code></li>
</ul>
<p><strong>实例练习</strong><br>准备工作</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-keyword">use</span> test2;<br><span class="hljs-keyword">for</span>(var i = <span class="hljs-number">1</span>; i&lt;= <span class="hljs-number">10</span>; i++)&#123;<br>	db.c3.insert( &#123;<span class="hljs-string">&quot;uname&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;zs&quot;</span>+i</span>,<span class="hljs-string">&quot;age&quot;</span><span class="hljs-symbol">:i</span>&#125; );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>1、将<code>&#123;uname:&quot;zs1&quot;&#125;</code>改为<code>&#123;uname:&quot;zs2&quot;&#125;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">db.c3.update(&#123;<span class="hljs-built_in">uname</span>:<span class="hljs-string">&quot;zs1&quot;</span>&#125;,&#123;<span class="hljs-variable">$set</span>:&#123;<span class="hljs-built_in">uname</span>:<span class="hljs-string">&quot;zs2&quot;</span>&#125;&#125;)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/fca89a535c7e20bc0c1ad3d5d6af10ea.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>2、给<code>&#123;uname:&quot;zs10&quot;&#125;</code>的年龄加<code>2</code>岁或减<code>2</code>岁</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">db.c3.<span class="hljs-title function_ invoke__">update</span>(&#123;<span class="hljs-attr">uname</span>:<span class="hljs-string">&quot;zs10&quot;</span>&#125;,&#123;<span class="hljs-variable">$inc</span>:&#123;<span class="hljs-attr">age</span>:<span class="hljs-number">2</span>&#125;&#125;)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/71d0d67de8fec5f2ca7ae77de9acab86.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>递减只需要将<code>2</code>改为<code>-2</code>即可。</p>
<p>综合练习插入数据：<br><code>db.c4.insert( &#123;uname:&quot;神龙教主&quot;,age:888,who:&quot;男&quot;,other:&quot;非国人&quot;&#125;)</code>;</p>
<h4 id="1-6-4-删除文档"><a href="#1-6-4-删除文档" class="headerlink" title="1.6.4 删除文档"></a>1.6.4 删除文档</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.集合名.<span class="hljs-built_in">remove</span>(条件[,是否删除一条])<br></code></pre></td></tr></table></figure>

<ul>
<li>是否删除一条<br><code>true</code>：是（删除的数据为第一条）</li>
</ul>
<p><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/b2c72ba0f3e05ec7b6a69887af149811.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><code>false</code>：否</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.c3.<span class="hljs-built_in">remove</span>(&#123;uname:<span class="hljs-string">&quot;zs3&quot;</span>&#125;)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/a288057288a936fc18516a170b455573.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="1-6-5-总结"><a href="#1-6-5-总结" class="headerlink" title="1.6.5 总结"></a>1.6.5 总结</h4><p>高级开发攻城狮统称：所有数据库都需要增删改查<code>CURD</code>标识</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">MongoDB`删除语法：`remove<br></code></pre></td></tr></table></figure>

<p>增<code>Create</code></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">db.集合名.<span class="hljs-keyword">insert</span>(<span class="hljs-type">JSON</span>数据)<br></code></pre></td></tr></table></figure>

<p>删<code>Delete</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.集合名.<span class="hljs-built_in">remove</span>(条件 [,是否删除一条<span class="hljs-literal">true</span>是<span class="hljs-literal">false</span>否默认])<br><br>也就是默认删除多条<br></code></pre></td></tr></table></figure>

<p>改<code>Update</code></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">db</span>.集合名.<span class="hljs-keyword">update</span>(条件， 新数据  [,是否新增,是否修改多条])<br><br>升级语法<span class="hljs-keyword">db</span>.集合名.<span class="hljs-keyword">update</span>(条件，&#123;修改器：&#123;键：值&#125;&#125;)<br></code></pre></td></tr></table></figure>

<p>查<code>Read</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.集合名.<span class="hljs-built_in">find</span>(条件 [,查询的列])<br></code></pre></td></tr></table></figure>

<h3 id="1-7-MongoDB存储数据类型"><a href="#1-7-MongoDB存储数据类型" class="headerlink" title="1.7 MongoDB存储数据类型"></a>1.7 <code>MongoDB</code>存储数据类型</h3><p><code>MongoDB</code>中每条记录称作一个文档，这个文档和我们平时用的<code>JSON</code>有点像，但也不完全一样。<code>JSON</code>是一种轻量级的数据交换格式。简洁和清晰的层次结构使得<code>JSON</code>成为理想的数据交换语言，<code>JSON</code>易于阅读和编写，同时也易于机器解析和生成，并有效地提升网络传输效率，但是<code>JSON</code>也有它的局限性，比如它只有<code>null</code>、布尔、数字、字符串、数组和对象这几种数据类型，<strong>没有日期类型，只有一种数字类型，无法区分浮点数和整数，也没法表示正则表达式或者函数</strong>。由于这些局限性，<code>BSON</code>闪亮登场啦，<code>BSON</code>是一种类<code>JSON</code>的二进制形式的存储格式，简称<code>Binary JSON</code>，它和<code>JSON</code>一样，支持内嵌的文档对象和数组对象，但是<code>BSON</code>有<code>JSON</code>没有的一些数据类型，如<code>Date</code>和<code>BinData</code>类型，<code>MongoDB</code>使用<code>BSON</code>做为文档数据存储和网络传输格式。</p>
<h4 id="1-7-1-数字"><a href="#1-7-1-数字" class="headerlink" title="1.7.1 数字"></a>1.7.1 数字</h4><p><code>shell</code>默认使用<code>64</code>位浮点型数值，如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collec</span><span class="hljs-selector-class">.insert</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-number">3.1415926</span>&#125;)<br>db<span class="hljs-selector-class">.sang_collec</span><span class="hljs-selector-class">.insert</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-number">3</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>对于整型值，我们可以使用<code>NumberInt</code>或者<code>NumberLong</code>表示，如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collec</span><span class="hljs-selector-class">.insert</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-built_in">NumberInt</span>(<span class="hljs-number">10</span>)&#125;)<br>db<span class="hljs-selector-class">.sang_collec</span><span class="hljs-selector-class">.insert</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">12</span>)&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="1-7-2-字符串"><a href="#1-7-2-字符串" class="headerlink" title="1.7.2 字符串"></a>1.7.2 字符串</h4><p>字符串也可以直接存储，如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collec</span><span class="hljs-selector-class">.insert</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-string">&quot;hello MongoDB!&quot;</span>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="1-7-3-正则表达式"><a href="#1-7-3-正则表达式" class="headerlink" title="1.7.3 正则表达式"></a>1.7.3 正则表达式</h4><p>正则表达式主要用在查询里边，查询时我们可以使用正则表达式，语法和<code>JavaScript</code>中正则表达式的语法相同，比如查询所有<code>key</code>为<code>x</code>，<code>value</code>以<code>hello</code>开始的文档且不区分大小写：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">db.sang_collec.<span class="hljs-built_in">find</span>(&#123;<span class="hljs-attr">x</span>:<span class="hljs-regexp">/^(hello)(.[a-zA-Z0-9])+/i</span>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="1-7-4-数组"><a href="#1-7-4-数组" class="headerlink" title="1.7.4 数组"></a>1.7.4 数组</h4><p>数组一样也是被支持的，如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">db</span>.sang_collec.insert(&#123;x:[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,new Date()]&#125;)<br></code></pre></td></tr></table></figure>

<p>数组中的数据类型可以是多种多样的。</p>
<h4 id="1-7-5-日期"><a href="#1-7-5-日期" class="headerlink" title="1.7.5 日期"></a>1.7.5 日期</h4><p><code>MongoDB</code>支持<code>Date</code>类型的数据，可以直接<code>new</code>一个<code>Date</code>对象，如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collec</span><span class="hljs-selector-class">.insert</span>(&#123;<span class="hljs-attribute">x</span>:new <span class="hljs-built_in">Date</span>()&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="1-7-6-内嵌文档"><a href="#1-7-6-内嵌文档" class="headerlink" title="1.7.6 内嵌文档"></a>1.7.6 内嵌文档</h4><p>一个文档也可以作为另一个文档的<code>value</code>，这个其实很好理解，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">db.sang_collect.<span class="hljs-title function_ invoke__">insert</span>(&#123;<span class="hljs-attr">name</span>:<span class="hljs-string">&quot;三国演义&quot;</span>,<span class="hljs-attr">author</span>:&#123;<span class="hljs-attr">name</span>:<span class="hljs-string">&quot;罗贯中&quot;</span>,<span class="hljs-attr">age</span>:<span class="hljs-number">99</span>&#125;&#125;);<br></code></pre></td></tr></table></figure>

<p>书有一个属性是作者，作者又有<code>name</code>，年龄等属性。</p>
<h3 id="1-8-MongoDB-中的索引"><a href="#1-8-MongoDB-中的索引" class="headerlink" title="1.8 MongoDB 中的索引"></a>1.8 <code>MongoDB</code> 中的索引</h3><h4 id="1-8-1-索引创建"><a href="#1-8-1-索引创建" class="headerlink" title="1.8.1 索引创建"></a>1.8.1 索引创建</h4><p>默认情况下，集合中的<code>_id</code>字段就是索引，我们可以通过<code>getIndexes()</code>方法来查看一个集合中的索引：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collect</span><span class="hljs-selector-class">.getIndexes</span>()<br></code></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ada">[<br>    &#123;<br>        <span class="hljs-string">&quot;v&quot;</span> : 2,<br>        <span class="hljs-string">&quot;key&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;_id&quot;</span> : 1<br>        &#125;,<br>        <span class="hljs-string">&quot;name&quot;</span> : &quot;_<span class="hljs-type">id</span>_<span class="hljs-string">&quot;,</span><br><span class="hljs-string">        &quot;</span>ns<span class="hljs-string">&quot; : &quot;</span>sang.sang_collect<span class="hljs-string">&quot;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">]</span><br></code></pre></td></tr></table></figure>

<p>我们看到这里只有一个索引，就是<code>_id</code>。</p>
<p>现在我的集合中有<code>10000</code>个文档，我想要查询<code>x</code>为<code>1</code>的文档，我的查询操作如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collect</span><span class="hljs-selector-class">.find</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-number">1</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>这种查询默认情况下会做全表扫描，我们可以用上篇文章介绍的<code>explain()</code>来查看一下查询计划，如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.sang_collect.<span class="hljs-built_in">find</span>(&#123;x:1&#125;).explain(<span class="hljs-string">&quot;executionStats&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs ada">&#123;<br>    <span class="hljs-string">&quot;queryPlanner&quot;</span> : &#123;<br>    &#125;,<br>    <span class="hljs-string">&quot;executionStats&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;executionSuccess&quot;</span> : <span class="hljs-type">true</span>,<br>        <span class="hljs-string">&quot;nReturned&quot;</span> : 1,<br>        <span class="hljs-string">&quot;executionTimeMillis&quot;</span> : 15,<br>        <span class="hljs-string">&quot;totalKeysExamined&quot;</span> : 0,<br>        <span class="hljs-string">&quot;totalDocsExamined&quot;</span> : 10000,<br>        <span class="hljs-string">&quot;executionStages&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;stage&quot;</span> : &quot;<span class="hljs-type">COLLSCAN</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">            &quot;</span>filter<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">                &quot;</span>x<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">                    &quot;</span>$eq<span class="hljs-string">&quot; : 1.0</span><br><span class="hljs-string">                &#125;</span><br><span class="hljs-string">            &#125;,</span><br><span class="hljs-string">            &quot;</span>nReturned<span class="hljs-string">&quot; : 1,</span><br><span class="hljs-string">            &quot;</span>executionTimeMillisEstimate<span class="hljs-string">&quot; : 29,</span><br><span class="hljs-string">            &quot;</span>works<span class="hljs-string">&quot; : 10002,</span><br><span class="hljs-string">            &quot;</span>advanced<span class="hljs-string">&quot; : 1,</span><br><span class="hljs-string">            &quot;</span>needTime<span class="hljs-string">&quot; : 10000,</span><br><span class="hljs-string">            &quot;</span>needYield<span class="hljs-string">&quot; : 0,</span><br><span class="hljs-string">            &quot;</span>saveState<span class="hljs-string">&quot; : 78,</span><br><span class="hljs-string">            &quot;</span>restoreState<span class="hljs-string">&quot; : 78,</span><br><span class="hljs-string">            &quot;</span>isEOF<span class="hljs-string">&quot; : 1,</span><br><span class="hljs-string">            &quot;</span>invalidates<span class="hljs-string">&quot; : 0,</span><br><span class="hljs-string">            &quot;</span>direction<span class="hljs-string">&quot; : &quot;</span>forward<span class="hljs-string">&quot;,</span><br><span class="hljs-string">            &quot;</span>docsExamined<span class="hljs-string">&quot; : 10000</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;</span>serverInfo<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;</span>ok<span class="hljs-string">&quot; : 1.0</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>结果比较长，我摘取了关键的一部分。我们可以看到查询方式是全表扫描，一共扫描了<code>10000</code>个文档才查出来我要的结果。实际上我要的文档就排第二个，但是系统不知道这个集合中一共有多少个<code>x</code>为<code>1</code>的文档，所以会把全表扫描完，这种方式当然很低效，但是如果我加上<code> limit</code>，如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">db</span>.sang_collect.find(&#123;x:<span class="hljs-number">1</span>&#125;).limit(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>此时再看查询计划发现只扫描了两个文档就有结果了，但是如果我要查询<code>x</code>为<code>9999</code>的记录，那还是得把全表扫描一遍，此时，我们就可以给该字段建立索引，索引建立方式如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collect</span><span class="hljs-selector-class">.ensureIndex</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-number">1</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>1表示升序，-1表示降序。当我们给x字段建立索引之后，再根据x字段去查询，速度就非常快了，我们看下面这个查询操作的执行计划：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">db.sang_collect.<span class="hljs-built_in">find</span>(&#123;x:9999&#125;).explain(<span class="hljs-string">&quot;executionStats&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>这个查询计划过长我就不贴出来了，我们可以重点关注查询要耗费的时间大幅度下降。</p>
<p>此时调用<code>getIndexes()</code>方法可以看到我们刚刚创建的索引，如下：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ada">[<br>    &#123;<br>        <span class="hljs-string">&quot;v&quot;</span> : 2,<br>        <span class="hljs-string">&quot;key&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;_id&quot;</span> : 1<br>        &#125;,<br>        <span class="hljs-string">&quot;name&quot;</span> : &quot;_<span class="hljs-type">id</span>_<span class="hljs-string">&quot;,</span><br><span class="hljs-string">        &quot;</span>ns<span class="hljs-string">&quot; : &quot;</span>sang.sang_collect<span class="hljs-string">&quot;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">        &quot;</span>v<span class="hljs-string">&quot; : 2,</span><br><span class="hljs-string">        &quot;</span>key<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">            &quot;</span>x<span class="hljs-string">&quot; : 1.0</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>name<span class="hljs-string">&quot; : &quot;</span>x_1<span class="hljs-string">&quot;,</span><br><span class="hljs-string">        &quot;</span>ns<span class="hljs-string">&quot; : &quot;</span>sang.sang_collect<span class="hljs-string">&quot;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">]</span><br></code></pre></td></tr></table></figure>

<p>我们看到每个索引都有一个名字，默认的索引名字为字段名_排序值，当然我们也可以在创建索引时自定义索引名字，如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">db<span class="hljs-selector-class">.sang_collect</span><span class="hljs-selector-class">.ensureIndex</span>(&#123;<span class="hljs-attribute">x</span>:<span class="hljs-number">1</span>&#125;,&#123;name:<span class="hljs-string">&quot;myfirstindex&quot;</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>此时创建好的索引如下：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ada">&#123;<br>    <span class="hljs-string">&quot;v&quot;</span> : 2,<br>    <span class="hljs-string">&quot;key&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;x&quot;</span> : 1.0<br>    &#125;,<br>    <span class="hljs-string">&quot;name&quot;</span> : &quot;<span class="hljs-type">myfirstindex</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>ns<span class="hljs-string">&quot; : &quot;</span>sang.sang_collect<span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>当然索引在创建的过程中还有许多其他可选参数，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">db.sang_collect.<span class="hljs-title function_ invoke__">ensureIndex</span>(&#123;<span class="hljs-attr">x</span>:<span class="hljs-number">1</span>&#125;,&#123;<span class="hljs-attr">name</span>:<span class="hljs-string">&quot;myfirstindex&quot;</span>,<span class="hljs-attr">dropDups</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">background</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">unique</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">sparse</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">v</span>:<span class="hljs-number">1</span>,<span class="hljs-attr">weights</span>:<span class="hljs-number">99999</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>关于这里的参数，我说一下：</p>
<blockquote>
<p>1.<code>name</code>表示索引的名称<br>2.<code>dropDups</code>表示创建唯一性索引时如果出现重复，则将重复的删除，只保留第一个<br>3.<code>background</code>是否在后台创建索引，在后台创建索引不影响数据库当前的操作，默认为<code>false</code><br>4.<code>unique</code>是否创建唯一索引，默认<code>false</code><br>5.<code>sparse</code>对文档中不存在的字段是否不起用索引，默认<code>false</code><br>6.<code>v</code>表示索引的版本号，默认为<code>2</code><br>7.<code>weights</code>表示索引的权重</p>
</blockquote>
<p>此时创建好的索引如下：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ada">&#123;<br>    <span class="hljs-string">&quot;v&quot;</span> : 1,<br>    <span class="hljs-string">&quot;unique&quot;</span> : <span class="hljs-type">true</span>,<br>    <span class="hljs-string">&quot;key&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;x&quot;</span> : 1.0<br>    &#125;,<br>    <span class="hljs-string">&quot;name&quot;</span> : &quot;<span class="hljs-type">myfirstindex</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>ns<span class="hljs-string">&quot; : &quot;</span>sang.sang_collect<span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>background<span class="hljs-string">&quot; : true,</span><br><span class="hljs-string">    &quot;</span>sparse<span class="hljs-string">&quot; : true,</span><br><span class="hljs-string">    &quot;</span>weights<span class="hljs-string">&quot; : 99999.0</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="1-8-2-查看索引"><a href="#1-8-2-查看索引" class="headerlink" title="1.8.2 查看索引"></a>1.8.2 查看索引</h4><p><code>getIndexes()</code>可以用来查看索引，我们还可以通过<code>totalIndexSize()</code>来查看索引的大小，如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collect</span><span class="hljs-selector-class">.totalIndexSize</span>()<br></code></pre></td></tr></table></figure>

<h4 id="1-8-3-删除索引"><a href="#1-8-3-删除索引" class="headerlink" title="1.8.3 删除索引"></a>1.8.3 删除索引</h4><p>我们可以按名称删除索引，如下：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas">db.sang_collect.<span class="hljs-keyword">drop</span><span class="hljs-meta">Index</span>(<span class="hljs-string">&quot;xIndex&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>表示删除一个名为<code>xIndex</code>的索引，当然我们也可以删除所有索引，如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.sang_collect</span><span class="hljs-selector-class">.dropIndexes</span>()<br></code></pre></td></tr></table></figure>

<h4 id="1-8-4-总结"><a href="#1-8-4-总结" class="headerlink" title="1.8.4 总结"></a>1.8.4 总结</h4><p>索引是个好东西，可以有效的提高查询速度，但是索引会降低插入、更新和删除的速度，因为这些操作不仅要更新文档，还要更新索引，<code>MongoDB</code> 限制每个集合上最多有<code>64</code>个索引，我们在创建索引时要仔细斟酌索引的字段。</p>
<h3 id="1-9-Java操作MongoDB"><a href="#1-9-Java操作MongoDB" class="headerlink" title="1.9 Java操作MongoDB"></a>1.9 <code>Java</code>操作<code>MongoDB</code></h3><h4 id="1-9-1-方式一"><a href="#1-9-1-方式一" class="headerlink" title="1.9.1 方式一"></a>1.9.1 方式一</h4><p>方式一采用的原生<code>Java</code>操作<code>MongoDB</code></p>
<h5 id="1-9-1-1-前期准备"><a href="#1-9-1-1-前期准备" class="headerlink" title="1.9.1.1 前期准备"></a>1.9.1.1 前期准备</h5><p>首先我们需要驱动，<code>MongoDB</code>的<code>Java</code>驱动我们可以直接在<code>Maven</code>中央仓库去下载，也可以创建<code>Maven</code>工程添加如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mongodb-driver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>建议通过<code>Maven</code>来添加依赖，如果自己下载jar，需要下载如下三个jar：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>.org.mongodb:bson:jar:<span class="hljs-number">3</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">2</span>.org.mongodb:mongodb-driver-core:jar:<span class="hljs-number">3</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">3</span>.org.mongodb:mongodb-driver:jar:<span class="hljs-number">3</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>另外，在使用<code>Java</code>操作 <code>MongoDB </code>之前，记得启动 <code>MongoDB</code></p>
<h5 id="1-9-1-2-获取集合"><a href="#1-9-1-2-获取集合" class="headerlink" title="1.9.1.2 获取集合"></a>1.9.1.2 获取集合</h5><p>所有准备工作完成之后，我们首先需要一个MongoClient，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MongoClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoClient</span>(<span class="hljs-string">&quot;192.168.248.136&quot;</span>, <span class="hljs-number">27017</span>);<br></code></pre></td></tr></table></figure>

<p>然后通过如下方式获取一个数据库，如果要获取的数据库本身就存在，直接获取到，不存在<code>MongoDB</code>会自动创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MongoDatabase</span> <span class="hljs-variable">sang</span> <span class="hljs-operator">=</span> client.getDatabase(<span class="hljs-string">&quot;sang&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>然后通过如下方式获取一个名为c1的集合，这个集合存在的话就直接获取到，不存在的话<code>MongoDB</code>会自动创建出来，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">MongoCollection&lt;Document&gt; c = sang.getCollection(<span class="hljs-string">&quot;c1&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>有了集合之后，我们就可以向集合中插入数据了。</p>
<p>1、<strong>增加操作</strong><br>和在<code>shell</code>中的操作一样，我们可以一条一条的添加数据，也可以批量添加，添加单条数据操作如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Document</span> <span class="hljs-variable">d1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();<br>d1.append(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;三国演义&quot;</span>).append(<span class="hljs-string">&quot;author&quot;</span>, <span class="hljs-string">&quot;罗贯中&quot;</span>);<br>c.insertOne(d1);<br></code></pre></td></tr></table></figure>

<p>添加多条数据的操作如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Document&gt; collections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Document&gt;();<br><span class="hljs-type">Document</span> <span class="hljs-variable">d1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();<br>d1.append(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;三国演义&quot;</span>).append(<span class="hljs-string">&quot;author&quot;</span>, <span class="hljs-string">&quot;罗贯中&quot;</span>);<br>collections.add(d1);<br><span class="hljs-type">Document</span> <span class="hljs-variable">d2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();<br>d2.append(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;红楼梦&quot;</span>).append(<span class="hljs-string">&quot;author&quot;</span>, <span class="hljs-string">&quot;曹雪芹&quot;</span>);<br>collections.add(d2);<br>c.insertMany(collections);<br></code></pre></td></tr></table></figure>

<p>当然也可以通过 <code>Robo 3T</code>查看修改结果：<code>db.集合名.find()</code><br><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/c0f4f0d5d94a332fbdd3ee69582176dc.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>2、<strong>修改操作</strong><br>可以修改查到的第一条数据，操作如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">c.updateOne(Filters.e<span class="hljs-string">q(&quot;author&quot;, &quot;罗贯中&quot;)</span>, new Document(<span class="hljs-string">&quot;<span class="hljs-variable">$set</span>&quot;</span>, new Document(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;三国演义123&quot;</span>)));<br></code></pre></td></tr></table></figure>

<p>上例中小伙伴们也看到了修改器要如何使用，不管是<code>inc</code>，用法都一致，我这里不再一个一个演示。也可以修改查到的所有数据，如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">c.updateMany(Filters.e<span class="hljs-string">q(&quot;author&quot;, &quot;罗贯中&quot;)</span>, new Document(<span class="hljs-string">&quot;<span class="hljs-variable">$set</span>&quot;</span>, new Document(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;三国演义456&quot;</span>)));<br></code></pre></td></tr></table></figure>

<p>3、<strong>删除操作</strong><br>可以删除查到的一条数据，如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">c.deleteOne(Filters.e<span class="hljs-string">q(&quot;author&quot;, &quot;罗贯中&quot;)</span>);<br></code></pre></td></tr></table></figure>

<p>也可以删除查到的所有数据：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">c.deleteMany(Filters.e<span class="hljs-string">q(&quot;author&quot;, &quot;罗贯中&quot;)</span>);<br></code></pre></td></tr></table></figure>

<p><code>Filters</code>里边还有其他的查询条件，都是见名知意，不赘述。</p>
<p>4、 <strong>查询操作</strong><br>可以直接查询所有文档：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">FindIterable&lt;Document&gt; documents = c.find();<br>MongoCursor&lt;Document&gt; iterator = documents.iterator();<br><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>    System.out.println(iterator.next());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也可以按照条件查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">FindIterable&lt;Document&gt; documents = c.find(Filters.eq(<span class="hljs-string">&quot;author&quot;</span>, <span class="hljs-string">&quot;罗贯中&quot;</span>));<br>MongoCursor&lt;Document&gt; iterator = documents.iterator();<br><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>    System.out.println(iterator.next());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其他的方法基本都是见名知意，这里不再赘述。</p>
<p>5、<strong>验证问题</strong><br>上面我们演示的获取一个集合是不需要登录<code>MongoDB</code>数据库的，如果需要登录，我们获取集合的方式改为下面这种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ServerAddress</span> <span class="hljs-variable">serverAddress</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerAddress</span>(<span class="hljs-string">&quot;192.168.248.128&quot;</span>, <span class="hljs-number">27017</span>);<br>List&lt;MongoCredential&gt; credentialsList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;MongoCredential&gt;();<br><span class="hljs-type">MongoCredential</span> <span class="hljs-variable">mc</span> <span class="hljs-operator">=</span> MongoCredential.createScramSha1Credential(<span class="hljs-string">&quot;readuser&quot;</span>,<span class="hljs-string">&quot;sang&quot;</span>,<span class="hljs-string">&quot;123&quot;</span>.toCharArray());<br>credentialsList.add(mc);<br><span class="hljs-type">MongoClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoClient</span>(serverAddress,credentialsList);<br><span class="hljs-type">MongoDatabase</span> <span class="hljs-variable">sang</span> <span class="hljs-operator">=</span> client.getDatabase(<span class="hljs-string">&quot;sang&quot;</span>);<br>c = sang.getCollection(<span class="hljs-string">&quot;c1&quot;</span>);<br></code></pre></td></tr></table></figure>

<p><code>MongoCredential</code>是一个凭证，第一个参数为用户名，第二个参数是要在哪个数据库中验证，第三个参数是密码的<code>char</code>数组，然后将登录地址封装成一个<code>ServerAddress</code>，最后将两个参数都传入<code>MongoClient</code>中实现登录功能。</p>
<p>6、<strong>其他配置</strong><br>在连接数据库的时候也可以设置连接超时等信息，在<code>MongoClientOptions</code>中设置即可，设置方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ServerAddress</span> <span class="hljs-variable">serverAddress</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerAddress</span>(<span class="hljs-string">&quot;192.168.248.128&quot;</span>, <span class="hljs-number">27017</span>);<br>List&lt;MongoCredential&gt; credentialsList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;MongoCredential&gt;();<br><span class="hljs-type">MongoCredential</span> <span class="hljs-variable">mc</span> <span class="hljs-operator">=</span> MongoCredential.createScramSha1Credential(<span class="hljs-string">&quot;rwuser&quot;</span>,<span class="hljs-string">&quot;sang&quot;</span>,<span class="hljs-string">&quot;123&quot;</span>.toCharArray());<br>credentialsList.add(mc);<br><span class="hljs-type">MongoClientOptions</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> MongoClientOptions.builder()<br>        <span class="hljs-comment">//设置连接超时时间为10s</span><br>        .connectTimeout(<span class="hljs-number">1000</span>*<span class="hljs-number">10</span>)<br>        <span class="hljs-comment">//设置最长等待时间为10s</span><br>        .maxWaitTime(<span class="hljs-number">1000</span>*<span class="hljs-number">10</span>)<br>        .build();<br><span class="hljs-type">MongoClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoClient</span>(serverAddress,credentialsList,options);<br><span class="hljs-type">MongoDatabase</span> <span class="hljs-variable">sang</span> <span class="hljs-operator">=</span> client.getDatabase(<span class="hljs-string">&quot;sang&quot;</span>);<br>c = sang.getCollection(<span class="hljs-string">&quot;c1&quot;</span>);<br></code></pre></td></tr></table></figure>

<h4 id="1-9-2-方式二"><a href="#1-9-2-方式二" class="headerlink" title="1.9.2 方式二"></a>1.9.2 方式二</h4><p>主要讲解<code>SpringBoot</code>操作<code>MongoDB</code>实现增删改查的功能</p>
<p>1、<code>pom.xml</code>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、创建<code>application.yml</code></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  data:</span><br><span class="hljs-symbol">    mongodb:</span><br><span class="hljs-symbol">      host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.72</span><span class="hljs-number">.129</span><br><span class="hljs-symbol">      database:</span> studentdb<br></code></pre></td></tr></table></figure>

<p>3、创建实体类<br>创建包<code>com.changan.mongodb</code>，包下建包<code>pojo </code>用于存放实体类，创建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changan.mongdb.pojo;<br><br><span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Document(collection = &quot;student&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> String sex;<br><br>    <span class="hljs-keyword">private</span> String age;<br><br>    <span class="hljs-keyword">private</span> String introduce;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSex</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sex;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSex</span><span class="hljs-params">(String sex)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sex = sex;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(String age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIntroduce</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> introduce;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntroduce</span><span class="hljs-params">(String introduce)</span> &#123;<br>        <span class="hljs-built_in">this</span>.introduce = introduce;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4、创建数据访问接口<br><code>com.changan.mongodb</code>包下创建<code>dao</code>包，包下创建接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changan.mongdb.dao;<br><br><span class="hljs-keyword">import</span> com.changan.mongdb.pojo.Student;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StudentDao</span> &#123;<br><br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(Student student)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Student student)</span>;<br><br>    List&lt;Student&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Integer id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5、创建业务逻辑类<br><code>com.changan.mongodb</code>包下创建<code>impl</code>包，包下创建类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changan.mongdb.dao.impl;<br><br><span class="hljs-keyword">import</span> com.changan.mongdb.dao.StudentDao;<br><span class="hljs-keyword">import</span> com.changan.mongdb.pojo.Student;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.aggregation.Aggregation;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.aggregation.LookupOperation;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Query;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Update;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StudentDao</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> student</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(Student student)</span> &#123;<br>        mongoTemplate.save(student);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> student</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Student student)</span> &#123;<br>        <span class="hljs-comment">//修改的条件</span><br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;id&quot;</span>).is(student.getId()));<br><br>        <span class="hljs-comment">//修改的内容</span><br>        <span class="hljs-type">Update</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Update</span>();<br>        update.set(<span class="hljs-string">&quot;name&quot;</span>,student.getName());<br><br>        mongoTemplate.updateFirst(query,update,Student.class);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询所有信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;Student&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mongoTemplate.findAll(Student.class);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id查询所有信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">byId</span> <span class="hljs-operator">=</span> mongoTemplate.findById(<span class="hljs-number">1</span>,Student.class);<br>        mongoTemplate.remove(byId);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>6、创建测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changan.mongdb;<br><br><span class="hljs-keyword">import</span> com.changan.mongdb.dao.StudentDao;<br><span class="hljs-keyword">import</span> com.changan.mongdb.pojo.Student;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongdbApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StudentDao studentDao;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询所有信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> &#123;<br>        List&lt;Student&gt; all = studentDao.findAll();<br>        System.out.println(all.size());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setId(<span class="hljs-number">6l</span>);<br>        student.setName(<span class="hljs-string">&quot;宋人头&quot;</span>);<br>        studentDao.save(student);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setId(<span class="hljs-number">2l</span>);<br>        student.setName(<span class="hljs-string">&quot;吴很帅&quot;</span>);<br>        studentDao.update(student);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;<br>        studentDao.delete(<span class="hljs-number">3</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-10-MongoDB之副本集配置"><a href="#1-10-MongoDB之副本集配置" class="headerlink" title="1.10 MongoDB之副本集配置"></a>1.10 <code>MongoDB</code>之副本集配置</h3><h4 id="1-10-1-MongoDB主从复制"><a href="#1-10-1-MongoDB主从复制" class="headerlink" title="1.10.1 MongoDB主从复制"></a>1.10.1 <code>MongoDB</code>主从复制</h4><p>主从复制是<code>MongoDB</code>最早使用的复制方式， 该复制方式易于配置，并且可以支持任意数量的从节点服务器，与使用单节点模式相比有如下优点：</p>
<p>在从服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。</p>
<p>可配置读写分离，主节点负责写操作，从节点负责读操作，将读写压力分开，提高系统的稳定性。<br><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/5aee83169015789b07f22b9beb8b04b5.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><code>MongoDB </code>的主从复制至少需要两个服务器或者节点。其中一个是主节点，负责处理客户端请求，其它的都是从节点，负责同步主节点的数据。</p>
<p>主节点记录在其上执行的所有写操作，从节点定期轮询主节点获取这些操作，然后再对自己的数据副本执行这些操作。由于和主节点执行了相同的操作，从节点就能保持与主节点的数据同步。</p>
<p>主节点的操作记录称为<code>oplog(operation log)</code>，它被存储在<code> MongoDB</code> 的 <code>local </code>数据库中。<code>oplog</code> 中的每个文档都代表主节点上执行的一个操作。需要重点强调的是<code>oplog</code>只记录改变数据库状态的操作。比如，查询操作就不会被存储在<code>oplog</code>中。这是因为<code>oplog</code>只是作为从节点与主节点保持数据同步的机制。</p>
<p>然而，主从复制并非生产环境下推荐的复制方式，主要原因如下两点：</p>
<p>1、灾备都是完全人工的 如果主节点发生故障失败，管理员必须关闭一个从服务器，然后作为主节点重新启动它。然后应用程序必须重新配置连接新的主节点。<br>2、数据恢复困难 因为<code>oplog</code>只在主节点存在，故障失败需要在新的服务器上创建新的<code>oplog</code>，这意味着任意存在的节点需要重新从新的主节点同步<code>oplog</code>。</p>
<p>因此，在新版本的<code>MongoDB</code>中已经不再支持使用主从复制这种复制方式了，取而代之的是使用副本集复制方式。</p>
<h4 id="1-10-2-MongoDB副本集"><a href="#1-10-2-MongoDB副本集" class="headerlink" title="1.10.2 MongoDB副本集"></a>1.10.2 <code>MongoDB</code>副本集</h4><p><code>MongoDB</code>副本集<code>（Replica Set）</code>其实就是具有自动故障恢复功能的主从集群，和主从复制最大的区别就是在副本集中没有固定的“主节点；整个副本集会选出一个节点作为“主节点”，当其挂掉后，再在剩下的从节点中选举一个节点成为新的“主节点”，在副本集中总有一个主节点<code>(primary)</code>和一个或多个备份节点<code>(secondary)</code>。</p>
<p>除了<code>primary</code>和<code>secondary</code>之外，副本集中的节点还可以是以下角色：</p>
<table>
<thead>
<tr>
<th></th>
<th>成为primary</th>
<th>对客户端可见</th>
<th>参与投票</th>
<th>延迟同步</th>
<th>复制数据</th>
</tr>
</thead>
<tbody><tr>
<td>Default</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>∕</td>
<td>√</td>
</tr>
<tr>
<td>Secondary-Only</td>
<td>∕</td>
<td>√</td>
<td>√</td>
<td>∕</td>
<td>√</td>
</tr>
<tr>
<td>Hidden</td>
<td>∕</td>
<td>∕</td>
<td>√</td>
<td>∕</td>
<td>√</td>
</tr>
<tr>
<td>Delayed∕</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>Arbiters</td>
<td>∕</td>
<td>∕</td>
<td>√</td>
<td>∕</td>
<td>∕</td>
</tr>
<tr>
<td>Non-Voting</td>
<td>√</td>
<td>√</td>
<td>∕</td>
<td>∕</td>
<td>√</td>
</tr>
</tbody></table>
<p>官方推荐的副本集最小配置需要有三个节点：一个主节点接收和处理所有的写操作，两个备份节点通过复制主节点的操作来对主节点的数据进行同步备份。<br><img src="/2021/03/17/MongoDB%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/0e4dfe349ae74b8f9737f9e3f6ff57b1.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h5 id="1-10-2-1-配置副本集"><a href="#1-10-2-1-配置副本集" class="headerlink" title="1.10.2.1 配置副本集"></a>1.10.2.1 配置副本集</h5><p>1、环境准备<br>副本集各节点<code>IP</code>如下：</p>
<blockquote>
<p>172.16.250.234<br>172.16.250.239<br>172.16.250.240</p>
</blockquote>
<p>首先，先对三个<code>MongoDB</code> 节点进行安装。</p>
<p>然后，依次修改各个节点的 <code>mongodb.conf </code>配置文件，增加副本集相关配置，内容如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">dbpath</span>=/usr/local/mongodb-4.0.2/data<br><span class="hljs-attribute">logpath</span>=/usr/local/mongodb-4.0.2/log/mongodb.log<br><span class="hljs-attribute">fork</span>=<span class="hljs-literal">true</span><br><span class="hljs-attribute">logappend</span>=<span class="hljs-literal">true</span><br>bind_ip= # 此处填写服务器的IP<br><span class="hljs-attribute">port</span>=27017<br><br><span class="hljs-comment"># 设置副本集名称，在各个配置文件中，其值必须相同</span><br><span class="hljs-attribute">replSet</span>=rs0<br></code></pre></td></tr></table></figure>

<p>配置完成之后，分别在三个节点上执行如下命令通过加载文件配置来启动<code>MongoDB</code>服务：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mongod</span> -config /usr/local/mongodb-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>/mongodb.conf<br><span class="hljs-comment"># 或者</span><br><span class="hljs-attribute">mongod</span> -f /usr/local/mongodb-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>/mongodb.conf<br></code></pre></td></tr></table></figure>

<p>至此，<code>3</code>个<code>MongoDB</code>实例都已经以副本集方式启动，但它们彼此之间现在还不会进行通信，仍需要进行一些配置。</p>
<p>2、<strong>副本集初始化</strong><br>通过<code>Shell</code>连接到任意一个<code>MongoDB</code>实例，执行<code>rs.initiate()</code>方法对副本集进行初始化。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-attr">[root@hadoop34 mongodb-4.0.2]</span># mongo <span class="hljs-number">172.16</span>.<span class="hljs-number">250.234</span>:<span class="hljs-number">27017</span><br>&gt; conf=<br>    &#123;<br>    &quot;_id&quot; : <span class="hljs-string">&quot;rs0&quot;</span>,<br>    <span class="hljs-string">&quot;members&quot;</span> : [<br>        &#123; &quot;_id&quot; : <span class="hljs-number">0</span>, <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;172.16.250.234:27017&quot;</span> &#125;,<br>        &#123; &quot;_id&quot; : <span class="hljs-number">1</span>, <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span> &#125;,<br>        &#123; &quot;_id&quot; : <span class="hljs-number">2</span>, <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;172.16.250.240:27017&quot;</span> &#125;<br>        ]<br>    &#125;<br>&gt; rs<span class="hljs-selector-class">.initiate</span>(conf)<br>&#123;<br>    &quot;ok&quot; : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542247326</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        &quot;clusterTime&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542247326</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>            &quot;hash&quot; : <span class="hljs-built_in">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>)<br>        &#125;<br>    &#125;<br>&#125;<br>rs0:SECONDARY&gt;<br></code></pre></td></tr></table></figure>

<p>如果在执行<code>rs.initiate()</code>方法时不传入任何参数，<code>MongoDB </code>将以默认的配置文档对副本集进行初始化，后续可以再通过<code>rs.add()</code>方法来向副本集中添加成员。</p>
<p>3、<strong>副本集更新</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 向副本集中添加成员</span><br>rs.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>)<br> <br><span class="hljs-comment"># 从副本集中删除成员</span><br>rs.<span class="hljs-built_in">remove</span>(<span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>)<br> <br><span class="hljs-comment"># 向副本集中添加仲裁</span><br>rs.addArb(<span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>)<br> <br><span class="hljs-comment"># 向副本集中添加备份节点</span><br>rs.<span class="hljs-built_in">add</span>(&#123;<span class="hljs-string">&quot;_id&quot;</span>:3,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>,<span class="hljs-string">&quot;priority&quot;</span>:0,<span class="hljs-string">&quot;hidden&quot;</span>:true&#125;)<br></code></pre></td></tr></table></figure>

<hr>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs ada"># 更改副本集配置<br>rs0:PRIMARY&gt; var conf=rs.conf()<br>rs0:PRIMARY&gt; conf.members[<span class="hljs-number">1</span>].priority = <span class="hljs-number">5</span><br> <br># PRIMARY节点上执行如下命令<br>rs0:PRIMARY&gt; rs.reconfig(conf)<br>&#123;<br>    <span class="hljs-string">&quot;ok&quot;</span> : 1,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-type">Timestamp</span>(<span class="hljs-number">1542248518</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-type">Timestamp</span>(<span class="hljs-number">1542248518</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-type">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-type">NumberLong</span>(<span class="hljs-number">0</span>)<br>        &#125;<br>    &#125;<br>&#125;<br> <br># SECONDARY节点上执行如下命令，需增加 force 参数<br>rs0:SECONDARY&gt; rs.reconfig(conf,&#123;force:<span class="hljs-literal">true</span>&#125;)<br>&#123;<br>    <span class="hljs-string">&quot;ok&quot;</span> : 1,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-type">Timestamp</span>(<span class="hljs-number">1542248726</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;clusterTime&quot;</span> : <span class="hljs-type">Timestamp</span>(<span class="hljs-number">1542248726</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;hash&quot;</span> : <span class="hljs-type">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-type">NumberLong</span>(<span class="hljs-number">0</span>)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>例如，强制让一个节点成为<code>Primary</code>，可以将该节点的优先级设置成最高。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">cfg = rs<span class="hljs-selector-class">.conf</span>()<br>cfg<span class="hljs-selector-class">.members</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.priority</span> = <span class="hljs-number">5</span><br>cfg<span class="hljs-selector-class">.members</span><span class="hljs-selector-attr">[1]</span><span class="hljs-selector-class">.priority</span> = <span class="hljs-number">1</span><br>cfg<span class="hljs-selector-class">.members</span><span class="hljs-selector-attr">[2]</span><span class="hljs-selector-class">.priority</span> = <span class="hljs-number">1</span><br>rs<span class="hljs-selector-class">.reconfig</span>(cfg)<br></code></pre></td></tr></table></figure>

<p>4、<strong>副本集监控</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><code class="hljs css"># 查看副本集的配置信息<br>rs0:PRIMARY&gt; rs.<span class="hljs-built_in">conf</span>()<br>&#123;<br>    &quot;_id&quot; : <span class="hljs-string">&quot;rs0&quot;</span>,<br>    <span class="hljs-string">&quot;version&quot;</span> : <span class="hljs-number">104658</span>,<br>    <span class="hljs-string">&quot;protocolVersion&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;writeConcernMajorityJournalDefault&quot;</span> : true,<br>    <span class="hljs-string">&quot;members&quot;</span> : [<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;172.16.250.234:27017&quot;</span>,<br>        <span class="hljs-string">&quot;arbiterOnly&quot;</span> : false,<br>        <span class="hljs-string">&quot;buildIndexes&quot;</span> : true,<br>        <span class="hljs-string">&quot;hidden&quot;</span> : false,<br>        <span class="hljs-string">&quot;priority&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;tags&quot;</span> : &#123;&#125;,<br>        &quot;slaveDelay&quot; : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;votes&quot;</span> : <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;arbiterOnly&quot;</span> : false,<br>        <span class="hljs-string">&quot;buildIndexes&quot;</span> : true,<br>        <span class="hljs-string">&quot;hidden&quot;</span> : false,<br>        <span class="hljs-string">&quot;priority&quot;</span> : <span class="hljs-number">5</span>,<br>        <span class="hljs-string">&quot;tags&quot;</span> : &#123;&#125;,<br>        &quot;slaveDelay&quot; : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;votes&quot;</span> : <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;host&quot;</span> : <span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>,<br>        <span class="hljs-string">&quot;arbiterOnly&quot;</span> : false,<br>        <span class="hljs-string">&quot;buildIndexes&quot;</span> : true,<br>        <span class="hljs-string">&quot;hidden&quot;</span> : false,<br>        <span class="hljs-string">&quot;priority&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;tags&quot;</span> : &#123;&#125;,<br>        &quot;slaveDelay&quot; : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;votes&quot;</span> : <span class="hljs-number">1</span><br>    &#125;],<br>    &quot;settings&quot; : &#123;<br>        &quot;chainingAllowed&quot; : true,<br>        <span class="hljs-string">&quot;heartbeatIntervalMillis&quot;</span> : <span class="hljs-number">2000</span>,<br>        <span class="hljs-string">&quot;heartbeatTimeoutSecs&quot;</span> : <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&quot;electionTimeoutMillis&quot;</span> : <span class="hljs-number">10000</span>,<br>        <span class="hljs-string">&quot;catchUpTimeoutMillis&quot;</span> : -<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;catchUpTakeoverDelayMillis&quot;</span> : <span class="hljs-number">30000</span>,<br>        <span class="hljs-string">&quot;getLastErrorModes&quot;</span> : &#123;&#125;,<br>        &quot;getLastErrorDefaults&quot; : &#123;<br>            &quot;w&quot; : <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;wtimeout&quot;</span> : <span class="hljs-number">0</span><br>        &#125;,<br>        &quot;replicaSetId&quot; : <span class="hljs-built_in">ObjectId</span>(<span class="hljs-string">&quot;5becd39e360189766762e057&quot;</span>)<br>    &#125;<br>&#125;<br># 查看副本集运行状态<br>rs0:PRIMARY&gt; rs.<span class="hljs-built_in">status</span>()<br>&#123;<br>    &quot;set&quot; : <span class="hljs-string">&quot;rs0&quot;</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:15.138Z&quot;</span>),<br>    <span class="hljs-string">&quot;myState&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;term&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>),<br>    <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;heartbeatIntervalMillis&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2000</span>),<br>    <span class="hljs-string">&quot;optimes&quot;</span> : &#123;<br>        &quot;lastCommittedOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;readConcernMajorityOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;appliedOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;durableOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;<br>    &#125;,<br>    &quot;lastStableCheckpointTimestamp&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249916</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;members&quot;</span> : [<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.234:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">2651</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;optimeDurable&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:06Z&quot;</span>),<br>        <span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:06Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:13.520Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:13.519Z&quot;</span>),<br>        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104658</span><br>        &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;PRIMARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">2799</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:06Z&quot;</span>),<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;electionTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542248524</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;electionDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:22:04Z&quot;</span>),<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104658</span>,<br>        <span class="hljs-string">&quot;self&quot;</span> : true,<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span><br>    &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">1855</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;optimeDurable&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:06Z&quot;</span>),<br>        <span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:06Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:13.520Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T02:46:13.520Z&quot;</span>),<br>        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104658</span><br>    &#125;],<br>    &quot;ok&quot; : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        &quot;clusterTime&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542249966</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>            &quot;hash&quot; : <span class="hljs-built_in">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>)<br>        &#125;<br>    &#125;<br>&#125;<br># 查看备份节点的复制信息<br>rs0:PRIMARY&gt; db.<span class="hljs-built_in">printSlaveReplicationInfo</span>()<br>source: <span class="hljs-number">172.16</span>.<span class="hljs-number">250.234</span>:<span class="hljs-number">27017</span><br>    syncedTo: Thu Nov <span class="hljs-number">15</span> <span class="hljs-number">2018</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">36</span> GMT+<span class="hljs-number">0800</span> (CST)<br>    <span class="hljs-number">0</span> secs (<span class="hljs-number">0</span> hrs) behind the primary<br>source: <span class="hljs-number">172.16</span>.<span class="hljs-number">250.240</span>:<span class="hljs-number">27017</span><br>    syncedTo: Thu Jan <span class="hljs-number">01</span> <span class="hljs-number">1970</span> <span class="hljs-number">08</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> GMT+<span class="hljs-number">0800</span> (CST)<br>    <span class="hljs-number">1542251316</span> secs (<span class="hljs-number">428403.14</span> hrs) behind the primary<br></code></pre></td></tr></table></figure>

<h5 id="1-10-2-2-副本集测试"><a href="#1-10-2-2-副本集测试" class="headerlink" title="1.10.2.2 副本集测试"></a>1.10.2.2 副本集测试</h5><p>在<code>Primary </code>上插入一万条客户数据：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">rs0:PRIMARY&gt; <span class="hljs-built_in">for</span>(var i=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;<span class="hljs-number">10000</span>;<span class="hljs-selector-tag">i</span>++)&#123;db<span class="hljs-selector-class">.customer</span><span class="hljs-selector-class">.insert</span>(&#123;&quot;name&quot;:<span class="hljs-string">&quot;user&quot;</span>+i&#125;)&#125;<br>WriteResult(&#123; &quot;nInserted&quot; : <span class="hljs-number">1</span> &#125;)<br>rs0:PRIMARY&gt; db.customer.<span class="hljs-built_in">count</span>()<br><span class="hljs-number">10000</span><br></code></pre></td></tr></table></figure>

<p>在<code>Secondary</code>上查看客户数据是否已经同步：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">rs0:SECONDARY&gt; rs<span class="hljs-selector-class">.slaveOk</span>()<br>rs0:SECONDARY&gt; db<span class="hljs-selector-class">.customer</span><span class="hljs-selector-class">.count</span>()<br><span class="hljs-number">10000</span><br></code></pre></td></tr></table></figure>

<p><strong>故障转移测试</strong><br>执行如下命令关闭<code>Primary</code>节点，查看其他<code>2</code>个节点的情况：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><code class="hljs css">mongod <span class="hljs-attr">--shutdown</span> <span class="hljs-attr">--dbpath</span> /usr/local/mongodb-<span class="hljs-number">4.0</span>.<span class="hljs-number">2</span>/data<br># 查看Primary节点关闭之前的状态<br>rs0:PRIMARY&gt; rs.<span class="hljs-built_in">status</span>()<br>&#123;<br>    &quot;set&quot; : <span class="hljs-string">&quot;rs0&quot;</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:31.393Z&quot;</span>),<br>    <span class="hljs-string">&quot;myState&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;term&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>),<br>    <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;heartbeatIntervalMillis&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2000</span>),<br>    <span class="hljs-string">&quot;optimes&quot;</span> : &#123;<br>        &quot;lastCommittedOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;readConcernMajorityOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;appliedOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;durableOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;<br>    &#125;,<br>    &quot;lastStableCheckpointTimestamp&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252978</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;members&quot;</span> : [<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.234:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">425</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;optimeDurable&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:28Z&quot;</span>),<br>        <span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:28Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:31.243Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:30.233Z&quot;</span>),<br>        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span><br>    &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;PRIMARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">428</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:28Z&quot;</span>),<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;electionTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252577</span>, <span class="hljs-number">2</span>),<br>        <span class="hljs-string">&quot;electionDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:29:37Z&quot;</span>),<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span>,<br>        <span class="hljs-string">&quot;self&quot;</span> : true,<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span><br>    &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">78</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;optimeDurable&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:28Z&quot;</span>),<br>        <span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:28Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:31.376Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:36:29.597Z&quot;</span>),<br>        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span><br>    &#125;],<br>    &quot;ok&quot; : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        &quot;clusterTime&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542252988</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>            &quot;hash&quot; : <span class="hljs-built_in">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>)<br>        &#125;<br>    &#125;<br>&#125;<br># 在任意其他节点上查看Primary节点关闭之后的状态<br>&gt; rs<span class="hljs-selector-class">.status</span>()<br>&#123;<br>    &quot;set&quot; : <span class="hljs-string">&quot;rs0&quot;</span>,<br>    <span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:31.213Z&quot;</span>),<br>    <span class="hljs-string">&quot;myState&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;term&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">5</span>),<br>    <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;heartbeatIntervalMillis&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2000</span>),<br>    <span class="hljs-string">&quot;optimes&quot;</span> : &#123;<br>        &quot;lastCommittedOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253290</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">5</span>)<br>        &#125;,<br>        &quot;readConcernMajorityOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253290</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">5</span>)<br>        &#125;,<br>        &quot;appliedOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253290</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">5</span>)<br>        &#125;,<br>        &quot;durableOpTime&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253290</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">5</span>)<br>        &#125;<br>    &#125;,<br>    &quot;lastStableCheckpointTimestamp&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253268</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;members&quot;</span> : [<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.234:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;PRIMARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">6115</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253290</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">5</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:30Z&quot;</span>),<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;could not find member to sync from&quot;</span>,<br>        <span class="hljs-string">&quot;electionTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253288</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;electionDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:28Z&quot;</span>),<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span>,<br>        <span class="hljs-string">&quot;self&quot;</span> : true,<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span><br>    &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">8</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;(not reachable/healthy)&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(-<span class="hljs-number">1</span>)<br>        &#125;,<br>        &quot;optimeDurable&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(-<span class="hljs-number">1</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;1970-01-01T00:00:00Z&quot;</span>),<br>        <span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;1970-01-01T00:00:00Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:30.593Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:18.148Z&quot;</span>),<br>        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;Error connecting to 172.16.250.239:27017 :: caused by ::     Connection refused&quot;</span>,<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : -<span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>        &quot;_id&quot; : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>,<br>        <span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>        <span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">372</span>,<br>        <span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253268</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;optimeDurable&quot; : &#123;<br>            &quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253268</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">4</span>)<br>        &#125;,<br>        &quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:08Z&quot;</span>),<br>        <span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:08Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:30.591Z&quot;</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:41:31.106Z&quot;</span>),<br>        <span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span><br>    &#125;],<br>    &quot;ok&quot; : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253290</span>, <span class="hljs-number">1</span>),<br>    <span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>        &quot;clusterTime&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253290</span>, <span class="hljs-number">1</span>),<br>        <span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>            &quot;hash&quot; : <span class="hljs-built_in">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>            <span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再次启动<code>172.16.250.239:27017</code>节点，由于其选举优先级最高，自动被选举为<code>Primary</code>。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs css"># 待<span class="hljs-number">172.16</span>.<span class="hljs-number">250.239</span>:<span class="hljs-number">27017</span> 节点启动后再次查看副本集状态<br>&gt; rs.<span class="hljs-built_in">status</span>()<br>&#123;<br>	&quot;set&quot; : <span class="hljs-string">&quot;rs0&quot;</span>,<br>	<span class="hljs-string">&quot;date&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:44:01.745Z&quot;</span>),<br>	<span class="hljs-string">&quot;myState&quot;</span> : <span class="hljs-number">2</span>,<br>	<span class="hljs-string">&quot;term&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>),<br>	<span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>	<span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>	<span class="hljs-string">&quot;syncSourceId&quot;</span> : <span class="hljs-number">1</span>,<br>	<span class="hljs-string">&quot;heartbeatIntervalMillis&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">2000</span>),<br>	<span class="hljs-string">&quot;optimes&quot;</span> : &#123;<br>		&quot;lastCommittedOpTime&quot; : &#123;<br>			&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>			<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>		&#125;,<br>		&quot;readConcernMajorityOpTime&quot; : &#123;<br>			&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>			<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>		&#125;,<br>		&quot;appliedOpTime&quot; : &#123;<br>			&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>			<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>		&#125;,<br>		&quot;durableOpTime&quot; : &#123;<br>			&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>			<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>		&#125;<br>	&#125;,<br>	&quot;lastStableCheckpointTimestamp&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253400</span>, <span class="hljs-number">1</span>),<br>	<span class="hljs-string">&quot;members&quot;</span> : [<br>		&#123;<br>			&quot;_id&quot; : <span class="hljs-number">0</span>,<br>			<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.234:27017&quot;</span>,<br>			<span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>			<span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>			<span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">6265</span>,<br>			<span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>				&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>				<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>			&#125;,<br>			&quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:43:55Z&quot;</span>),<br>			<span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>			<span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>			<span class="hljs-string">&quot;syncSourceId&quot;</span> : <span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span>,<br>			<span class="hljs-string">&quot;self&quot;</span> : true,<br>			<span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span><br>		&#125;,<br>		&#123;<br>			&quot;_id&quot; : <span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>			<span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;PRIMARY&quot;</span>,<br>			<span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">23</span>,<br>			<span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>				&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>				<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>			&#125;,<br>			&quot;optimeDurable&quot; : &#123;<br>				&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>				<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>			&#125;,<br>			&quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:43:55Z&quot;</span>),<br>			<span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:43:55Z&quot;</span>),<br>			<span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:44:01.228Z&quot;</span>),<br>			<span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:44:00.835Z&quot;</span>),<br>			<span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>			<span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-string">&quot;syncSourceId&quot;</span> : -<span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-string">&quot;electionTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253424</span>, <span class="hljs-number">1</span>),<br>			<span class="hljs-string">&quot;electionDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:43:44Z&quot;</span>),<br>			<span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span><br>		&#125;,<br>		&#123;<br>			&quot;_id&quot; : <span class="hljs-number">2</span>,<br>			<span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;172.16.250.240:27017&quot;</span>,<br>			<span class="hljs-string">&quot;health&quot;</span> : <span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;state&quot;</span> : <span class="hljs-number">2</span>,<br>			<span class="hljs-string">&quot;stateStr&quot;</span> : <span class="hljs-string">&quot;SECONDARY&quot;</span>,<br>			<span class="hljs-string">&quot;uptime&quot;</span> : <span class="hljs-number">522</span>,<br>			<span class="hljs-string">&quot;optime&quot;</span> : &#123;<br>				&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>				<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>			&#125;,<br>			&quot;optimeDurable&quot; : &#123;<br>				&quot;ts&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>				<span class="hljs-string">&quot;t&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">6</span>)<br>			&#125;,<br>			&quot;optimeDate&quot; : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:43:55Z&quot;</span>),<br>			<span class="hljs-string">&quot;optimeDurableDate&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:43:55Z&quot;</span>),<br>			<span class="hljs-string">&quot;lastHeartbeat&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:44:01.166Z&quot;</span>),<br>			<span class="hljs-string">&quot;lastHeartbeatRecv&quot;</span> : <span class="hljs-built_in">ISODate</span>(<span class="hljs-string">&quot;2018-11-15T03:44:01.414Z&quot;</span>),<br>			<span class="hljs-string">&quot;pingMs&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>),<br>			<span class="hljs-string">&quot;lastHeartbeatMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-string">&quot;syncingTo&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>			<span class="hljs-string">&quot;syncSourceHost&quot;</span> : <span class="hljs-string">&quot;172.16.250.239:27017&quot;</span>,<br>			<span class="hljs-string">&quot;syncSourceId&quot;</span> : <span class="hljs-number">1</span>,<br>			<span class="hljs-string">&quot;infoMessage&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-string">&quot;configVersion&quot;</span> : <span class="hljs-number">104666</span><br>		&#125;<br>	],<br>	&quot;ok&quot; : <span class="hljs-number">1</span>,<br>	<span class="hljs-string">&quot;operationTime&quot;</span> : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>	<span class="hljs-string">&quot;$clusterTime&quot;</span> : &#123;<br>		&quot;clusterTime&quot; : <span class="hljs-built_in">Timestamp</span>(<span class="hljs-number">1542253435</span>, <span class="hljs-number">1</span>),<br>		<span class="hljs-string">&quot;signature&quot;</span> : &#123;<br>			&quot;hash&quot; : <span class="hljs-built_in">BinData</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),<br>			<span class="hljs-string">&quot;keyId&quot;</span> : <span class="hljs-built_in">NumberLong</span>(<span class="hljs-number">0</span>)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="1-10-2-3-开启安全认证"><a href="#1-10-2-3-开启安全认证" class="headerlink" title="1.10.2.3 开启安全认证"></a>1.10.2.3 开启安全认证</h5><p><strong>创建用户</strong><br>登录 <code>PRIMARY</code>节点创建用户，在此我们对 <code>test</code> 库开启安全认证。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">rs0:<span class="hljs-keyword">PRIMARY</span>&gt; <span class="hljs-keyword">show</span> dbs<br><span class="hljs-keyword">admin</span>   <span class="hljs-number">0.000</span>GB<br>config  <span class="hljs-number">0.000</span>GB<br><span class="hljs-keyword">local</span>   <span class="hljs-number">0.002</span>GB<br>test    <span class="hljs-number">0.000</span>GB<br>rs0:<span class="hljs-keyword">PRIMARY</span>&gt; use <span class="hljs-keyword">admin</span><br>switched <span class="hljs-keyword">to</span> db <span class="hljs-keyword">admin</span><br>rs0:<span class="hljs-keyword">PRIMARY</span>&gt; db.createUser(&#123;<span class="hljs-keyword">user</span>:&quot;root&quot;,pwd:&quot;123456&quot;,roles:[&#123;<span class="hljs-keyword">role</span>:&quot;userAdminAnyDatabase&quot;,db:&quot;admin&quot;&#125;]&#125;)<br>Successfully added <span class="hljs-keyword">user</span>: &#123;<br>	&quot;user&quot; : &quot;root&quot;,<br>	&quot;roles&quot; : [<br>		&#123;<br>			&quot;role&quot; : &quot;userAdminAnyDatabase&quot;,<br>			&quot;db&quot; : &quot;admin&quot;<br>		&#125;<br>	]<br>&#125;<br>rs0:<span class="hljs-keyword">PRIMARY</span>&gt; use test<br>switched <span class="hljs-keyword">to</span> db test<br>rs0:<span class="hljs-keyword">PRIMARY</span>&gt; db.createUser(&#123;<span class="hljs-keyword">user</span>:&quot;admin&quot;,pwd:&quot;admin&quot;,roles:[&#123;<span class="hljs-keyword">role</span>:&quot;readWrite&quot;,db:&quot;test&quot;&#125;]&#125;)<br>Successfully added <span class="hljs-keyword">user</span>: &#123;<br>	&quot;user&quot; : &quot;admin&quot;,<br>	&quot;roles&quot; : [<br>		&#123;<br>			&quot;role&quot; : &quot;readWrite&quot;,<br>			&quot;db&quot; : &quot;test&quot;<br>		&#125;<br>	]<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>创建<code>keyFile</code>文件</strong><br>先停掉所有<code>SECONDARY</code>节点的<code>MongoDB</code>服务，然后再停掉<code>PRIMARY</code>节点的<code>MongoDB</code>服务，并在<code>PRIMARY</code>节点所在服务器上创建<code>keyFile</code>文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@hadoop39 mongodb-4.0.2]# openssl rand -<span class="hljs-built_in">base64</span> 666 &gt; /usr/local/mongodb-4.0.2/keyfile<br>[root@hadoop39 mongodb-4.0.2]# <span class="hljs-built_in">chmod</span> 600 /usr/local/mongodb-4.0.2/keyfile<br></code></pre></td></tr></table></figure>

<p>将生成的<code>keyFile</code>文件拷贝到其他节点服务器上，并修改文件的操作权限为<code> 600</code>。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">chmod</span> <span class="hljs-number">600</span> /usr/local/mongodb-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>/keyfile<br></code></pre></td></tr></table></figure>

<p>更新启动配置文件<br>修改<code>PRIMARY</code>节点的 <code>mongodb.conf </code>文件，增加如下内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># Add below Config</span><br><span class="hljs-attr">auth</span>=<span class="hljs-literal">true</span><br><span class="hljs-attr">oplogSize</span>=<span class="hljs-number">100</span><br><span class="hljs-attr">keyFile</span>=/usr/local/mongodb-<span class="hljs-number">4.0</span>.<span class="hljs-number">2</span>/keyfile<br></code></pre></td></tr></table></figure>

<p>修改<code>SECONDARY</code>节点的 <code>mongodb.conf </code>文件，增加如下内容：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># Add below Config</span><br><span class="hljs-attribute">oplogSize</span>=<span class="hljs-number">100</span><br><span class="hljs-attribute">keyFile</span>=/usr/local/mongodb-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>/keyfile<br></code></pre></td></tr></table></figure>

<p><strong>启动副本集</strong><br>先以<code> --auth</code> 方式启动<code>PRIMARY</code>节点：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@hadoop39</span> mongodb<span class="hljs-operator">-</span><span class="hljs-number">4.0</span>.<span class="hljs-number">2</span>]# mongod <span class="hljs-operator">-</span>f <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mongodb-4.0.2/</span>mongodb.conf<br></code></pre></td></tr></table></figure>

<p>再启动<code>SECONDARY</code>节点：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mongod</span> -f /usr/local/mongodb-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>/mongodb.conf<br></code></pre></td></tr></table></figure>

<p><strong>登录测试</strong></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hadoop39 mongodb<span class="hljs-string">-4</span>.0.2]# mongo -uadmin -padmin 172.16.250.239:27017<br>MongoDB shell version v4.0.2<br>connecting to: mongodb://172.16.250.239:27017/test<br>MongoDB server version: 4.0.2<br>rs0:PRIMARY&gt; show dbs;<br><span class="hljs-keyword">test </span>0.000GB<br></code></pre></td></tr></table></figure>

<p><code>admin</code>用户只能看到<code>test</code>库。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">数据库</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">非关系型数据库</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/MongoDB/" class="print-no-link">#MongoDB</a>
      
        <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="print-no-link">#数据库</a>
      
        <a href="/tags/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" class="print-no-link">#非关系型数据库</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MongoDB图文详解</div>
      <div>http://example.com/2021/03/17/MongoDB图文详解/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>吕书科</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年3月17日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/22/Redis%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/" title="Redis图文详解">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Redis图文详解</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/01/03/2021%E5%B9%B4%E5%BA%A6%E6%AD%8C%E5%8D%95/" title="2021年度歌单">
                        <span class="hidden-mobile">2021年度歌单</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
